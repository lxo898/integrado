{% extends "base.html" %} {# Fixed syntax error v2 #}
{% block title %}{{ form.instance.pk|yesno:"Editar reserva,Nueva reserva" }}{% endblock %}

{% block content %}
<section class="p-4 rounded-4 mb-4 inacap-hero">
  <h1 class="h3 m-0">{{ form.instance.pk|yesno:"‚úèÔ∏è Editar reserva,üóìÔ∏è Nueva reserva" }}</h1>
</section>

<style>
  form input[type="text"],
  form input[type="datetime-local"],
  form textarea,
  form select {
    width: 100%;
    padding: .6rem .8rem;
    border: 1px solid #dee2e6;
    border-radius: .5rem;
    background: #fff;
  }

  #conflictAlert {
    display: none;
  }

  #calendar {
    min-height: 520px;
  }

  .legend-dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: .4rem;
  }
</style>

<div class="card shadow-sm border-0 rounded-4">
  <div class="card-body">
    <div id="conflictAlert" class="alert alert-danger rounded-3 mb-4">
      ‚ö†Ô∏è Existe un conflicto de horario con otra reserva para este espacio. Ajusta la fecha/bloques para continuar.
    </div>

    <form id="resForm" method="post" novalidate>
      {% csrf_token %}

      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Espacio</label>
          {{ form.space }}
          {% if form.space.errors %}<div class="text-danger small">{{ form.space.errors }}</div>{% endif %}
        </div>

        <div class="col-md-2">
          <label class="form-label">Inicio</label>
          {{ form.date }}
          {% if form.date.errors %}<div class="text-danger small">{{ form.date.errors }}</div>{% endif %}
        </div>

        <div class="col-md-2">
          <label class="form-label">T√©rmino</label>
          {{ form.end_date }}
          {% if form.end_date.errors %}<div class="text-danger small">{{ form.end_date.errors }}</div>{% endif %}
        </div>

        <div class="col-md-2">
          <label class="form-label">Desde</label>
          {{ form.start_slot }}
          {% if form.start_slot.errors %}<div class="text-danger small">{{ form.start_slot.errors }}</div>{% endif %}
        </div>

        <div class="col-md-2">
          <label class="form-label">Hasta</label>
          {{ form.end_slot }}
          {% if form.end_slot.errors %}<div class="text-danger small">{{ form.end_slot.errors }}</div>{% endif %}
        </div>

        <div class="col-md-1">
          <label class="form-label">Pers.</label>
          {{ form.attendees_count }}
          {% if form.attendees_count.errors %}
          <div class="text-danger small">{{ form.attendees_count.errors }}</div>
          {% endif %}
        </div>
      </div>

      <div class="mt-3 mb-4">
        <label class="form-label">Motivo / prop√≥sito</label>
        {{ form.purpose }}
        {% if form.purpose.errors %}<div class="text-danger small">{{ form.purpose.errors }}</div>{% endif %}
      </div>

      <!-- ========= Solicitud de recursos por el usuario ========= -->
      <!-- ========= Solicitud de recursos por el usuario ========= -->
      <div class="mt-3 mb-4">
        <label class="form-label d-flex align-items-center gap-2">
          Recursos necesarios <span class="text-muted small">(opcional)</span>
        </label>

        <div class="card p-0 border-0 bg-light rounded-3 mb-3">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-borderless table-sm mb-0">
                <thead class="text-muted small text-uppercase">
                  <tr>
                    <th class="ps-3" style="width: 50%;">Recurso</th>
                    <th style="width: 30%;">Cantidad</th>
                  </tr>
                </thead>
                <tbody>
                  {% for res in resources_all %}
                  <tr class="align-middle">
                    <td class="ps-3">
                      <div class="form-check">
                        <input class="form-check-input resource-checkbox" type="checkbox" name="resources"
                          value="{{ res.id }}" id="res_{{ res.id }}">
                        <label class="form-check-label" for="res_{{ res.id }}">
                          {{ res.name }}
                          <span class="badge bg-light text-dark border ms-2 small avail-badge"
                            data-res-id="{{ res.id }}" data-total="{{ res.quantity }}">
                            Stock: {{ res.quantity }}
                          </span>
                        </label>
                      </div>
                    </td>
                    <td>
                      <input type="number" name="quantity_{{ res.id }}"
                        class="form-control form-control-sm resource-quantity" value="1" min="1"
                        max="{{ res.quantity }}" disabled style="width: 80px;" data-res-id="{{ res.id }}">
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="2" class="text-center text-muted py-3">No hay recursos disponibles</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>


      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const checkboxes = document.querySelectorAll('.resource-checkbox');
          checkboxes.forEach(cb => {
            cb.addEventListener('change', function () {
              const row = this.closest('tr');
              const qtyInput = row.querySelector('.resource-quantity');
              if (this.checked) {
                qtyInput.disabled = false;
                qtyInput.focus();
              } else {
                qtyInput.disabled = true;
              }
            });
          });
        });
      </script>
      <!-- ======================================================= -->
      <!-- ======================================================= -->

      <a href="{% url 'dashboard_user' %}" class="btn btn-outline-secondary rounded-3">Cancelar</a>
      <button id="submitBtn" type="submit" class="btn btn-primary rounded-3">Guardar</button>
    </form>
  </div>
</div>

<div class="card shadow-sm border-0 rounded-4 mt-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h5 m-0">Disponibilidad</h2>
      <div class="small text-muted">
        <span class="legend-dot" style="background:#198754"></span> Aprobada
        &nbsp;&nbsp;
        <span class="legend-dot" style="background:#ffc107"></span> Pendiente
      </div>
    </div>
    <div id="calendar"></div>
  </div>
</div>

<!-- FullCalendar (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/locales-all.global.min.js"></script>

<script>
  (function () {
    const availabilityUrl = "{% url 'availability_json' %}";
    const resourcesUrl = "{% url 'resource_availability_bulk' %}";
    const form = document.getElementById('resForm');
    const spaceEl = form.querySelector('[name="space"]');
    const dateEl = form.querySelector('[name="date"]');
    const endDateEl = form.querySelector('[name="end_date"]'); // Nuevo campo
    const startSlotEl = form.querySelector('[name="start_slot"]');
    const endSlotEl = form.querySelector('[name="end_slot"]');
    const alertEl = document.getElementById('conflictAlert');
    const submitBtn = document.getElementById('submitBtn');

    // Resource elements
    const availBadges = document.querySelectorAll('.avail-badge');
    const resourceInputs = document.querySelectorAll('.resource-quantity');

    let calendar;
    let eventsCache = [];

    function parseISODateTime(dStr, hmStr) {
      // dStr: "YYYY-MM-DD", hmStr: "HH:MM" ‚Üí Date
      if (!dStr || !hmStr) return null;
      const dtStr = dStr + 'T' + hmStr + ':00';
      const d = new Date(dtStr);
      return isNaN(d) ? null : d;
    }

    function overlaps(aStart, aEnd, bStart, bEnd) {
      return aStart < bEnd && aEnd > bStart;
    }

    async function loadEvents() {
      const space = spaceEl.value;
      if (!space) { eventsCache = []; renderCal([]); return; }
      const url = availabilityUrl + "?space=" + encodeURIComponent(space);
      const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
      eventsCache = res.ok ? await res.json() : [];
      renderCal(eventsCache);
      checkAll();
    }

    async function updateResources() {
      const d = dateEl.value;
      const ed = endDateEl.value || d; // Si no hay fecha t√©rmino, usa inicio
      const s = startSlotEl.value;
      const e = endSlotEl.value;
      if (!d || !s || !e) return;

      const url = resourcesUrl + `?date=${d}&end_date=${ed}&start=${s}&end=${e}`;
      try {
        const res = await fetch(url);
        if (res.ok) {
          const data = await res.json();
          // data.resources = { id: { available, total } }
          if (data.resources) {
            availBadges.forEach(badge => {
              const id = badge.getAttribute('data-res-id');
              const info = data.resources[id];
              if (info) {
                badge.textContent = `Disp: ${info.available} / Total: ${info.total}`;
                if (info.available === 0) {
                  badge.classList.remove('bg-light', 'text-dark');
                  badge.classList.add('bg-danger', 'text-white');
                } else {
                  badge.classList.remove('bg-danger', 'text-white');
                  badge.classList.add('bg-light', 'text-dark');
                }

                // Update max input
                const inp = document.querySelector(`.resource-quantity[data-res-id="${id}"]`);
                if (inp) {
                  inp.max = info.available;
                  if (parseInt(inp.value) > info.available) {
                    inp.value = Math.max(1, info.available);
                  }
                  if (info.available === 0) {
                    inp.value = 0;
                    inp.disabled = true;
                    // Find checkbox
                    const chk = document.getElementById(`res_${id}`);
                    if (chk) {
                      if (chk.checked) chk.checked = false;
                      chk.disabled = true;
                    }
                  } else {
                    // Re-enable checkbox if logic allows
                    const chk = document.getElementById(`res_${id}`);
                    if (chk) chk.disabled = false;
                  }
                }
              }
            });
          }
        }
      } catch (e) {
        console.error("Error fetching resources", e);
      }
    }

    function renderCal(events) {
      const el = document.getElementById('calendar');
      const isMobile = window.matchMedia('(max-width: 768px)').matches;

      if (!calendar) {
        calendar = new FullCalendar.Calendar(el, {
          locale: 'es',
          firstDay: 1,
          initialView: isMobile ? 'listWeek' : 'timeGridWeek',
          headerToolbar: isMobile
            ? { left: 'prev,next today', center: 'title', right: 'listWeek,dayGridMonth' }
            : { left: 'prev,next today', center: 'title', right: 'timeGridDay,timeGridWeek,dayGridMonth' },
          slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
          slotMinTime: '07:00:00',
          slotMaxTime: '22:00:00',
          nowIndicator: true,
          expandRows: true,
          height: 'auto',
          events: events.map(e => ({
            id: e.id,
            title: e.title,
            start: e.start,
            end: e.end,
            backgroundColor: e.backgroundColor,
            borderColor: e.borderColor,
            textColor: e.textColor,
          }))
        });
        calendar.render();
      } else {
        calendar.removeAllEvents();
        events.forEach(e => {
          calendar.addEvent({
            id: e.id,
            title: e.title,
            start: e.start,
            end: e.end,
            backgroundColor: e.backgroundColor,
            borderColor: e.borderColor,
            textColor: e.textColor,
          });
        });
      }
    }

    function checkConflict() {
      alertEl.style.display = 'none';
      submitBtn.disabled = false;

      const space = spaceEl.value;
      const d = dateEl.value;
      const ed = endDateEl.value || d;
      const sHM = startSlotEl.value;
      const eHM = endSlotEl.value;
      if (!space || !d || !sHM || !eHM) return;

      const s = parseISODateTime(d, sHM);
      const e = parseISODateTime(ed, eHM); // Usa ed (fecha t√©rmino)
      if (!s || !e) return;

      if (e <= s) {
        // Validaci√≥n b√°sica de fechas invertidas en JS
        // (Aunque el form lo valida en backend, mejor avisar visualmente si se pudiera,
        // pero por ahora solo chequeamos conflicto)
        return;
      }

      const conflict = eventsCache.some(ev => {
        const es = new Date(ev.start);
        const ee = new Date(ev.end);
        return overlaps(s, e, es, ee);
      });

      if (conflict) {
        alertEl.style.display = 'block';
        submitBtn.disabled = true;
      }
    }

    function checkAll() {
      checkConflict();
      updateResources();
    }

    spaceEl?.addEventListener('change', loadEvents);
    dateEl?.addEventListener('change', checkAll);
    endDateEl?.addEventListener('change', checkAll); // Listener nuevo
    startSlotEl?.addEventListener('change', checkAll);
    endSlotEl?.addEventListener('change', checkAll);

    loadEvents(); // inicial
  })();
</script>
{% endblock %}